@using System.Collections.Generic;
@using System.Globalization;
@using mojoPortal.Business;
@using mojoPortal.Business.WebHelpers;
@using mojoPortal.Web.Components;
@using mojoPortal.Web.Configuration;
@using mojoPortal.Web.Framework;
@using mojoPortal.Web;
@using mojoPortal.Web.UI;
@using Resources;

@model mojoPortal.Web.Models.MemberListModel

@{
	var timeOffset = SiteUtils.GetUserTimeOffset();
	var timeZone = SiteUtils.GetUserTimeZone();
	var siteRoot = SiteUtils.GetNavigationSiteRoot();
	var siteSettings = CacheHelper.GetCurrentSiteSettings();

	var isAdmin = WebUser.IsAdmin;
	var canManageUsers = isAdmin || WebUser.IsInRoles(siteSettings.RolesThatCanManageUsers);
	var canCreateUsers = canManageUsers || WebUser.IsInRoles(siteSettings.RolesThatCanCreateUsers);

	var pageNumber = WebUtils.ParseInt32FromQueryString("pagenumber", 1);
	var sortMode = WebUtils.ParseInt32FromQueryString("sd", 0); // 0 = displayName Asc, 1 = JoinDate Desc, 2 = Last, First
	var showLocked = WebUtils.ParseBoolFromQueryString("locked", false);
	var showUnApproved = WebUtils.ParseBoolFromQueryString("needapproval", false);
	var filterLetter = Server.UrlEncode(WebUtils.ParseStringFromQueryString("letter", string.Empty));
	var searchText = Server.UrlEncode(WebUtils.ParseStringFromQueryString("search", string.Empty));
	var ipSearchText = Server.UrlEncode(WebUtils.ParseStringFromQueryString("ips", string.Empty));

	var pagePath = siteRoot + "/MemberList.aspx";
	var pagerFormat = pagePath + "?pagenumber={0}" + "&letter=" + filterLetter + "&sd=" + sortMode;
	var siteAvatarPath = siteRoot + "/Data/Sites/" + siteSettings.SiteId.ToInvariantString() + "/useravatars";

	var displaySettings = Model.DisplaySettings;
	var showEmailInMemberList = WebConfigSettings.ShowEmailInMemberList || displaySettings.ShowEmail;
	var showUserIDInMemberList = canManageUsers && (WebConfigSettings.ShowUserIDInMemberList || displaySettings.ShowUserId);
	var showLoginNameInMemberList = canManageUsers && (WebConfigSettings.ShowLoginNameInMemberList || displaySettings.ShowLoginName);
	var showJoinDate = displaySettings.ShowJoinDate;

	// this can't be used in related site mode because we can't assume forum posts were in this site.
	var showForumPostColumn = WebConfigSettings.ShowForumPostsInMemberList && displaySettings.ShowForumPosts && !WebConfigSettings.UseRelatedSiteMode;

	var showWebSiteColumn = false;
	mojoProfileConfiguration profileConfig = mojoProfileConfiguration.GetConfig();
	if (profileConfig != null)
	{
		if (profileConfig.Contains("WebSiteUrl"))
		{
			mojoProfilePropertyDefinition webSiteUrlProperty = profileConfig.GetPropertyDefinition("WebSiteUrl");
			if (
				(webSiteUrlProperty.OnlyVisibleForRoles.Length == 0)
				|| (WebUser.IsInRoles(webSiteUrlProperty.OnlyVisibleForRoles))
				)
			{
				showWebSiteColumn = true;
			}

		}
	}

	// displaySettings can be configured from theme.skin
	if (displaySettings.HideWebSiteColumn) { showWebSiteColumn = false; }

}

@if (isAdmin)
{
	mojoPortal.Web.Models.BreadCrumbs crumbsModel = new mojoPortal.Web.Models.BreadCrumbs();
	crumbsModel.Crumbs = new List<BreadCrumb>
	{
		new BreadCrumb { Text = Resource.AdminMenuLink, Url = siteRoot + "/Admin/AdminMenu.aspx"},
		new BreadCrumb { Text = Resource.MemberListLink, Url = pagePath}
	};

	Html.RenderPartial("_BreadCrumbs", crumbsModel);
}
<div class="row">
	<div class="col-sm-6">
		<h2 class="m-t-0 moduletitle">@Resource.MemberListTitleLabel </h2>
	</div>

	<div class="col-sm-6 text-right form-inline">
		<div class="input-group">
			<input type="text" id="txtSearch" class="form-control" placeholder="@Resource.MemberListSearchPlaceholder" value="@searchText"/>
			<span class="input-group-btn"><button type="button" id="btnSearchUser" class="btn btn-default" onclick="DoSearch('user');">@Resource.MemberListSearchButton</button></span>
		</div>
	</div>
</div>
<hr />
@if (canCreateUsers || canManageUsers)
{
	<div class="row m-b-gutter">
		<div class="col-sm-12 form-inline">
			<div class="input-group">
				<input type="text" placeholder="@Resource.MemberListIPSearchPlaceholder" id="txtIPSearch" class="form-control" value="@ipSearchText">
				<span class="input-group-btn"><button type="button" id="btnSearchIP" class="btn btn-default" onclick="DoSearch('ip');">@Resource.MemberListSearchByIPLabel</button></span>
			</div>&nbsp;
			<a href="@siteRoot/Admin/ManageUsers.aspx?userId=-1" title="@Resource.MemberListAddUserTooltip" class="btn btn-success"><span class="fa fa-user-plus"></span>  @Resource.MemberListAddUserLabel</a>
			@if (!showLocked)
			{
				<a href="@pagePath?locked=true" title="@Resource.ShowLockedOutUsersTooltip" class="btn btn-info"><span class="fa fa-user-times"></span> @Resource.ShowLockedOutUsers</a>
			}
			@if (siteSettings.RequireApprovalBeforeLogin && !showUnApproved)
			{
				<a href="@pagePath?needapproval=true" title="@Resource.ShowNotApprovedUsersTooltip" class="btn btn-info"><span class="fa fa-user-o"></span> @Resource.ShowNotApprovedUsers</a>
			}
			@if (showLocked || showUnApproved || !string.IsNullOrWhiteSpace(searchText) || !string.IsNullOrWhiteSpace(filterLetter) || !string.IsNullOrWhiteSpace(ipSearchText))
			{
				<a href="@pagePath" title="@Resource.MemberListShowAllTooltip" class="btn btn-warning pull-right"><span class="fa fa-users"></span> @Resource.MemberListShowAllLabel</a>
			}

		</div>
	</div>
}
<div class="modulepager">
	<div class="member-list">
		<ul>
			<li><a href="@pagePath">@Resource.MemberListAllUsersLink</a></li>
			@foreach (char c in Resource.AlphaPagerChars)
			{
				<li><a class="@(filterLetter == c.ToString() ? "active" : "")" href="@pagePath?sd=2&pagenumber=1&letter=@c.ToString()">@c</a></li>
			}
		</ul>
	</div>
</div>

<table class="table table-striped table-bordered">
	<thead>
		<tr>
			<th>
				@{ var thNameString = Resource.MemberListUserNameLabel; }
				@if (displaySettings.ShowFirstAndLastName)
				{
					thNameString = Resource.Name;
				}
				 <a href="@pagePath">@thNameString</a>				
			</th>
			@if (showJoinDate) {<th><a href="@pagePath?sd=1">@Resource.MemberListDateCreatedLabel</a></th> }
			@if (showWebSiteColumn) { <th>@Resource.MemberListUserWebSiteLabel</th> }
			@if (showForumPostColumn) { <th>@Resource.MemberListUserTotalPostsLabel</th> }
			<th></th>
		</tr>
	</thead>
	<tbody>
		@foreach (var user in Model.Users)
		{
		<tr>
			<td>
				@{
					var nameString = user.Name;
					if ((displaySettings.ShowFirstAndLastName) && (user.FirstName.Length > 0) && (user.LastName.Length > 0))
					{
						nameString = string.Format(CultureInfo.InvariantCulture, Resource.MemberListNameFormat, user.LastName, user.FirstName);
					}
				}
				<span class="avatar"><img src="@(string.IsNullOrWhiteSpace(user.AvatarUrl) ? WebUtils.ResolveUrl("~/Data/SiteImages/anonymous.png") : siteAvatarPath + "/" + user.AvatarUrl)" style="width: 35px; height: 35px;" /></span>
				<span class="name">@nameString</span>
				@if (showEmailInMemberList || showLoginNameInMemberList || showUserIDInMemberList || (isAdmin && !user.DisplayInMemberList))
				{
					<ul class="list-unstyled">
						@if (showEmailInMemberList)
						{
							<li class="email"><a href="mailto:@user.Email">@user.Email</a></li>
						}
						@if (showLoginNameInMemberList)
						{
							<li class="login">@user.LoginName</li>
						}
						@if (showUserIDInMemberList)
						{
							<li class="userid">@Resource.RegisterLoginNameLabel @user.UserId</li>
						}
						@if (isAdmin && !user.DisplayInMemberList)
						{
							<li class="text-danger">@Resources.Resource.HiddenUser</li>
						}
					</ul>
				}
			</td>
			@if (showJoinDate) { <td>@DateTimeHelper.Format(user.DateCreated, timeZone, "d", timeOffset)</td> }
			@if (showWebSiteColumn) { <td><a rel="nofollow noreferrer noopener" href="@user.WebSiteUrl">@user.WebSiteUrl</a></td> }
			@if (showForumPostColumn) { <td>@user.TotalPosts</td> }
			<td>
				<a href="@(siteRoot)/ProfileView.aspx?userid=@user.UserId" class="btn btn-link">@Resource.MemberListViewProfileLabel</a> 
				@if (canManageUsers) { <a href="@(siteRoot)/Admin/ManageUsers.aspx?userid=@user.UserId" class="btn btn-warning">@Resource.ManageUserLink</a> }
			</td>
		</tr>
		}
	</tbody>
</table>

@if (Model.PagerInfo.PageCount > 0)
{
	var pagerModel = Model.PagerInfo;
	Html.RenderPartial("_Pager", pagerModel);
}

<script type="text/javascript">

	function DoSearch(type) {
		var search;
		var url = '@pagePath?';
		if (type === "user") {
			search = document.getElementById('txtSearch');
			url += "search=";
		}
		else if (type === "ip") {
			search = document.getElementById('txtIPSearch');
			url += "ips=";
		}

		var searchValue = encodeURIComponent(search.value);  // encode the search query
		window.location.href = url + searchValue;
	}
</script>